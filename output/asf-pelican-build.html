<!doctype html>
<html class="no-js" lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ASF-Pelican build process - Apache Infrastructure Website</title>
<link href="/css/bootstrap.min.css" rel="stylesheet">
<link href="/css/fontawesome.all.min.css" rel="stylesheet">
<link href="/css/headerlink.css" rel="stylesheet">
<script src="/highlight/highlight.min.js"></script>  </head>
  <body class="d-flex flex-column h-100">
  <main class="flex-shrink-0">
      <div>

<!-- nav bar -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark" aria-label="Fifth navbar example">
    <div class="container-fluid">
        <a class="navbar-brand" href="/"><img src="/images/feather.png" style="height: 32px;"/> Apache Infrastructure</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarADP" aria-controls="navbarADP" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarADP">
            <ul class="navbar-nav me-auto mb-2 mb-lg-0">
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">About</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/team.html">About the team</a></li>
                        <li><a class="dropdown-item" href="/roundtable.html">The Infrastructure Roundtable</a></li>
                        <li><a class="dropdown-item" href="/blog/">The Infrastructure Blog</a></li>
                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/policies.html">Policies</a>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">Services and Tools</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/services.html">Services and Tools</a></li>
                        <li><a class="dropdown-item" href="/machines.html">Machines and Fingerprints</a></li>
                        <li><a class="dropdown-item" href="https://blocky.apache.org/">Blocky</a></li>
                        <li><a class="dropdown-item" href="https://app.datadoghq.com/account/login?next=%2Finfrastructure">DataDog</a></li>
                        <li><a class="dropdown-item" href="https://whimsy.apache.org/roster/committer/" target="_blank">Committer Search</a></li>
                    </ul>
                </li>
                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown" aria-expanded="false">Documentation</a>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="/doc.html">Contribute</a></li>
                        <li><a class="dropdown-item" href="/infra-volunteer.html">Volunteer with Infra</a></li>
                        <li><a class="dropdown-item" href="/how-to-mirror.html">Become an ASF download mirror</a></li>
                        <li><a class="dropdown-item" href="/hosting-external-agent.html">Host a Jenkins or Buildbot agent</a></li>

                    </ul>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/stats.html">Status</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" href="/contact.html">Contact Us</a>
                </li>
            </ul>
        </div>
    </div>
</nav>    


<!-- page contents -->
<div id="contents">
    <div class="bg-white p-5 rounded">
        <div class="col-sm-8 mx-auto">
          <h1>
              ASF-Pelican build process
          </h1>
              <p>For websites using the ASf-Pelican template and the <a href="https://docs.getpelican.com/en/stable/" target="_blank">Pelican static site generator</a>, configure the build using the <code>pelicanconf.py</code> settings.</p>
<h2>Pelican theme</h2>
<div class="highlight"><pre><span></span><code><span class="c1"># Theme</span>
<span class="n">THEME</span> <span class="o">=</span> <span class="s1">&#39;./theme/apache&#39;</span>
</code></pre></div>

<p>See [ASF-Pelican theme][asf-pelican-theme.html] for details about the ASF Theme.</p>
<h2>Plugins</h2>
<p>ASF-Pelican enhances the Pelican environment with plugins. Our environment has its own copy of the <code>asf</code> plugins, and the <code>pelican-build.py</code> script provides <code>pelican-gfm</code>.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Pelican Plugins</span>
<span class="c1"># pelican-gfm is installed in the buildbot as part of build_pelican.py. It is an ASF Infra custom plugin.</span>
<span class="c1"># other plugins are discoverable and can be installed via pip by mentioning them in requirements.txt</span>
<span class="c1"># You can find plugins here: https://github.com/pelican-plugins</span>
<span class="c1"># Plugins that are custom for this site are found in PLUGIN_PATHS.</span>
<span class="n">PLUGIN_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;./theme/plugins&#39;</span><span class="p">]</span>
<span class="n">PLUGINS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;asfgenid&#39;</span><span class="p">,</span> <span class="s1">&#39;asfdata&#39;</span><span class="p">,</span> <span class="s1">&#39;pelican-gfm&#39;</span><span class="p">,</span> <span class="s1">&#39;asfreader&#39;</span><span class="p">]</span>
</code></pre></div>

<ol>
<li><a href="#data-model">Data Model</a>. The <code>asfdata.py</code> plugin builds a metadata model that is shared with every page.</li>
<li><a href="#pelican-gfm">GFM Content</a>. The <code>pelican-gfm</code> plugin reads <strong>.md</strong>, <strong>.markdown</strong>, <strong>.mkd</strong>, and <strong>.mdown</strong> files and converts the GFM Markdown into HTML.</li>
<li><a href="#ezmd-reader">EZMD Content</a>. The <code>asfreader.py</code> plugin reads <strong>.ezmd</strong> files, injects data, translates ezt, and converts the GFM Markdown into HTML.</li>
<li><a href="#generate-id">Generate ID</a>. The <code>asfgenid.py</code> plugin performs a number of enhancements to the HTML.</li>
</ol>
<p>See [ASF-Pelican build process][asf-pelican-build.html] for the steps signaled. See <a href="../theme/plugins/.">plugins</a>[asf-pelican-plugins.html] for the Python code.</p>
<h2>Tree structure</h2>
<p>Pages and static content are stored in the same tree. Generated content is output with the same relative path, except with an html extension.
These are the necessary settings:</p>
<div class="highlight"><pre><span></span><code><span class="n">PATH</span> <span class="o">=</span> <span class="s1">&#39;content&#39;</span>
<span class="c1"># Save pages using full directory preservation</span>
<span class="n">PAGE_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
<span class="c1"># Path with no extension</span>
<span class="n">PATH_METADATA</span> <span class="o">=</span> <span class="s1">&#39;(?P&lt;path_no_ext&gt;.*)\..*&#39;</span>
<span class="c1"># We are not slugifying any pages</span>
<span class="n">ARTICLE_URL</span> <span class="o">=</span> <span class="n">ARTICLE_SAVE_AS</span> <span class="o">=</span> <span class="n">PAGE_URL</span> <span class="o">=</span> <span class="n">PAGE_SAVE_AS</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{path_no_ext}</span><span class="s1">.html&#39;</span>
<span class="c1"># We want to serve our static files mixed with content</span>
<span class="n">STATIC_PATHS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;.&#39;</span><span class="p">]</span>
<span class="c1"># we want any html to be served as-is</span>
<span class="n">READERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;html&#39;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
<span class="c1"># ignore README.md files in the content tree and the interviews and include folders</span>
<span class="n">IGNORE_FILES</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;README.md&#39;</span><span class="p">,</span><span class="s1">&#39;interviews&#39;</span><span class="p">,</span><span class="s1">&#39;include&#39;</span><span class="p">]</span>
</code></pre></div>

<h1>Process</h1>
<p>Pelican uses <a href="https://docs.getpelican.com/en/latest/plugins.html#list-of-signals" target="_blank">signals</a> as it goes through the process of reading and generating content. It processes pages in no particular order. </p>
<p>Our plugins provide the following activity:</p>
<table>
<thead>
<tr>
<th>Pelican Signal</th>
<th>Step</th>
<th style="text-align: center;"><a href="#pelican-gfm">GFM Content</a></th>
<th style="text-align: center;"><a href="#ezmd-reader">EZMD Content</a></th>
<th>Description</th>
</tr>
</thead>
<tbody>
<tr>
<td>Initialization</td>
<td><a href="#data-model">Data Model</a></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td>Read data sources</td>
</tr>
<tr>
<td>Reader</td>
<td>Class</td>
<td style="text-align: center;"><a href="#pelican-gfm">GFMReader</a></td>
<td style="text-align: center;"><a href="#ezmd-reader">ASFReader(GFMReader)</a></td>
<td>Pelican Reader class</td>
</tr>
<tr>
<td></td>
<td><a href="#read-source">Read</a></td>
<td style="text-align: center;">read_source</td>
<td style="text-align: center;">super.read_source</td>
<td>Read page source and metadata</td>
</tr>
<tr>
<td></td>
<td><a href="#model-metadata">Model Metadata</a></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">add_data</td>
<td>Add asf data to the model and expand any <code>[{ reference }]</code></td>
</tr>
<tr>
<td></td>
<td><a href="#ezt-translation">Translate</a></td>
<td style="text-align: center;"></td>
<td style="text-align: center;">ezt</td>
<td>ezt template translation</td>
</tr>
<tr>
<td></td>
<td><a href="#render-gfm">Render GFM</a></td>
<td style="text-align: center;">render</td>
<td style="text-align: center;">super.render</td>
<td>Render GFM/HTML into HTML</td>
</tr>
<tr>
<td>Content</td>
<td><a href="#generate-id">Generate ID</a></td>
<td style="text-align: center;">generate_id</td>
<td style="text-align: center;">generate_id</td>
<td>Perform ASF specific HTML enhancements</td>
</tr>
<tr>
<td>Generator</td>
<td><a href="../theme/apache/templates/.">Template</a></td>
<td style="text-align: center;">translate</td>
<td style="text-align: center;">translate</td>
<td>Create output HTML by pushing the generated content and metadata through the theme's templates</td>
</tr>
</tbody>
</table>
<p>See [local builds][asf-pelican-local.html] for how to install ASF-Pelican on your system.</p>
<h2>Data model</h2>
<p><strong>ezmd</strong> templates use a shared data model to generate content. There are three types of data:</p>
<table>
<thead>
<tr>
<th>When referenced</th>
<th>Data type</th>
</tr>
</thead>
<tbody>
<tr>
<td>EZMD Reader, Content, Generator</td>
<td>Constants - either integer or string values</td>
</tr>
<tr>
<td>EZMD Reader</td>
<td>Sequences - arrays of objects with attributes where an attribute may be another sequence</td>
</tr>
<tr>
<td>EZMD Reader</td>
<td>Dictionaries - key-value maps where the value may be another dictionary</td>
</tr>
</tbody>
</table>
<p>The constants are also available to the <code>asfgenid.py</code> plugin and the [theme's templates][asf-pelican-theme.html].</p>
<p>There are examples of how to <a href="#model-metadata">inject shared metadata</a> below. See the [metadata model][asf-pelican-data.html] for how <code>asfdata.py</code> works to populate the shared metadata.</p>
<h2>Read source</h2>
<p>The systems uses the <code>read_source</code> method to open a file and convert it into a metadata dictionary and text.</p>
<p>Example:</p>
<div class="highlight"><pre><span></span><code>Title: ASF Export Classifications and Source Links
license: https://www.apache.org/licenses/LICENSE-2.0
asf_headings: False

<span class="gu">#### ASF Project</span>
...
</code></pre></div>

<p>The first three lines specify three <code>metadata</code> key-value pairs.
There is a blank line and the rest is the <code>text</code>.</p>
<p>Code from <code>pelican-gfm</code> with some parts elided.</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">read_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">source_path</span><span class="p">):</span>
        <span class="s2">&quot;Read metadata and content from the source.&quot;</span>
    <span class="o">...</span>
    <span class="c1"># Fetch the source content, with a few appropriate tweaks</span>
        <span class="k">with</span> <span class="n">pelican</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">pelican_open</span><span class="p">(</span><span class="n">source_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">text</span><span class="p">:</span>

            <span class="c1"># Extract the metadata from the header of the text</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">lines</span><span class="p">)):</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">GFMReader</span><span class="o">.</span><span class="n">RE_METADATA</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
                    <span class="n">name</span> <span class="o">=</span> <span class="n">match</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="o">...</span>
                    <span class="n">metadata</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                    <span class="c1"># blank line</span>
                    <span class="k">continue</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># reached actual content</span>
                    <span class="k">break</span>
        <span class="o">...</span>
            <span class="c1"># Reassemble content, minus the metadata</span>
            <span class="n">text</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="n">i</span><span class="p">:])</span>

            <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">metadata</span>
</code></pre></div>

<h2>Model Metadata <a id="ezmd"></a></h2>
<p>In <code>asfreader.py</code> we extend EZT syntax to do metadata substitution prior to EZT translation. This allows for a more natural and direct representation than with EZT sequences.</p>
<h3>Examples</h3>
<div class="highlight"><pre><span></span><code>|  |  |  |
|-----------|-----------|-------------|
| [{ board[0].name }] | [{ board[1].name }] | [{ board[2].name }] |
| [{ board[3].name }] | [{ board[4].name }] | [{ board[5].name }] |
| [{ board[6].name }] | [{ board[7].name }] | [{ board[8].name }] |
</code></pre></div>

<div class="highlight"><pre><span></span><code>| Office    | Individual  |
|-----------|-------------|
| Board Chair |  [<span class="nt">{ ci[boardchair</span>][<span class="nl">roster</span>] }] |
| Vice Chair |  [<span class="nt">{ ci[vicechair</span>][<span class="nl">roster</span>] }] |
| President |  [<span class="nt">{ ci[president</span>][<span class="nl">roster</span>] }] |
| Exec. V.P |  [<span class="nt">{ ci[execvp</span>][<span class="nl">roster</span>] }] |
| [[]Treasurer](https://treasurer.apache.org/) |  [<span class="nt">{ ci[treasurer</span>][<span class="nl">roster</span>] }] |
| Assistant Treasurer |  [<span class="nt">{ ci[assistanttreasurer</span>][<span class="nl">roster</span>] }] |
| Secretary |  [<span class="nt">{ ci[secretary</span>][<span class="nl">roster</span>] }] |
| Assistant Secretary |  [<span class="nt">{ ci[assistantsecretary</span>][<span class="nl">roster</span>] }] |
| V.P., [[]Legal Affairs](/legal/) |  [<span class="nt">{ ci[legal</span>][<span class="nl">chair</span>] }] |
| Assistant V.P., [[]Legal Affairs](/legal/) |  [<span class="nt">{ ci[assistantvplegalaffairs</span>][<span class="nl">roster</span>] }] |
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="k">-</span><span class="w"> </span>All volunteer community
<span class="k">-</span><span class="w"> </span>[{ code_lines }]+ lines of code in&amp;nbsp;stewardship
<span class="k">-</span><span class="w"> </span>[{ code_changed }]+ lines of code&amp;nbsp;changed
<span class="k">-</span><span class="w"> </span>[{ code_commits }]+ code commits
<span class="k">-</span><span class="w"> </span>[{ asf_members }] individual ASF&amp;nbsp;Members
<span class="k">-</span><span class="w"> </span>[{ asf_committers }]+ Apache Committers
<span class="k">-</span><span class="w"> </span>[{ asf_contributors }]+ code contributors
<span class="k">-</span><span class="w"> </span>[{ asf_people }]+ people involved in our&amp;nbsp;communities
</code></pre></div>

<h3>EZMD Reader</h3>
<p>The <code>asfreader.py</code> plugin is responsible for <a href="#read-source">reading the source</a>, adding metadata, <a href="#ezt-translation">ezt translation</a>, and <a href="#render-gfm">rendering GFM</a></p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="s2">&quot;Mix in ASF data as metadata&quot;</span>

        <span class="n">asf_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ASF_DATA&#39;</span><span class="p">,</span> <span class="p">{</span> <span class="p">})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;metadata&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">asf_metadata</span><span class="p">:</span>
            <span class="n">metadata</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">asf_metadata</span><span class="p">)</span>
            <span class="c1"># insert any direct references</span>
            <span class="n">m</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">while</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">METADATA_RE</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">text</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">this_data</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">format_string</span> <span class="o">=</span> <span class="s1">&#39;{{</span><span class="si">{0}</span><span class="s1">}}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">this_data</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">new_string</span> <span class="o">=</span> <span class="n">format_string</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">**</span><span class="n">metadata</span><span class="p">)</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{{{</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="se">}}}}</span><span class="s1"> -&gt; </span><span class="si">{</span><span class="n">new_string</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># the data expression was not found</span>
                        <span class="n">new_string</span> <span class="o">=</span> <span class="n">format_string</span>
                        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{{{</span><span class="si">{</span><span class="n">m</span><span class="o">.</span><span class="n">group</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span><span class="si">}</span><span class="se">}}}}</span><span class="s1"> is not found&#39;</span><span class="p">)</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">METADATA_RE</span><span class="p">,</span> <span class="n">new_string</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">text</span><span class="p">,</span> <span class="n">metadata</span>
</code></pre></div>

<h2>EZT Translation</h2>
<p><strong>ezmd</strong> page files are <a href="https://github.com/gstein/ezt">ezt</a> templates that create Markdown and HTML output. See <a href="https://github.com/gstein/ezt/blob/wiki/Syntax.md">EZT Syntax</a> for the directives.</p>
<h3>EZT Examples</h3>
<p>Project list:</p>
<div class="highlight"><pre><span></span><code>| Office    | Individual  |
|-----------|-------------|[for projects]
| V.P., [<span class="nt">if-any projects.site</span>][<span class="nl">[</span>][end]Apache [<span class="nt">projects.display_name</span>][<span class="nl">if-any projects.site</span>]]([projects.site])[end] | [projects.chair] |[end]
</code></pre></div>

<p>Featured projects:</p>
<div class="highlight"><pre><span></span><code>[for featured_projs]<span class="p">&lt;</span><span class="nt">li</span> <span class="err">[</span><span class="na">if-index</span> <span class="na">featured_projs</span> <span class="na">first</span><span class="err">]</span><span class="na">class</span><span class="o">=</span><span class="s">&quot;active&quot;</span><span class="err">[</span><span class="na">end</span><span class="err">]</span><span class="p">&gt;</span>
     <span class="p">&lt;</span><span class="nt">a</span> <span class="na">href</span><span class="o">=</span><span class="s">&quot;#[featured_projs.key_id]&quot;</span> <span class="na">data-toggle</span><span class="o">=</span><span class="s">&quot;tab&quot;</span><span class="p">&gt;</span>[featured_projs.display_name]<span class="p">&lt;/</span><span class="nt">a</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">li</span><span class="p">&gt;</span>[end]
</code></pre></div>

<p>Insert a file as-is into the output:</p>
<div class="highlight"><pre><span></span><code>Title: Apache Download Mirrors

[insertfile &quot;include/closer.ezt&quot;]
</code></pre></div>

<h3>EZT Code</h3>
<p>Code from <code>asfreader.py</code></p>
<div class="highlight"><pre><span></span><code>            <span class="c1"># prepare text as an ezt template</span>
            <span class="c1"># compress_whitespace=0 is required as blank lines and indentation have meaning in markdown</span>
            <span class="n">template</span> <span class="o">=</span> <span class="n">ezt</span><span class="o">.</span><span class="n">Template</span><span class="p">(</span><span class="n">compress_whitespace</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">reader</span> <span class="o">=</span> <span class="n">ASFTemplateReader</span><span class="p">(</span><span class="n">source_path</span><span class="p">,</span> <span class="n">text</span><span class="p">)</span>
            <span class="n">template</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">reader</span><span class="p">,</span> <span class="n">base_format</span><span class="o">=</span><span class="n">ezt</span><span class="o">.</span><span class="n">FORMAT_HTML</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">template</span>
            <span class="c1"># generate content from ezt template with metadata</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">io</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
            <span class="n">template</span><span class="o">.</span><span class="n">generate</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">metadata</span><span class="p">)</span>
</code></pre></div>

<h2>Render GFM</h2>
<p>Content is in <a href="gfm.html">GitHub Flavored Markdown</a> (GFM).</p>
<p>ASF-Pelican uses a version of <a href="https://github.com/github/cmark-gfm" target="_blank">cmark-gfm</a> by <a href="https://github.blog/2017-03-14-a-formal-spec-for-github-markdown/" target="_blank">GitHub</a> through the <code>pelican-gfm</code> plugin created by Apache Infra.</p>
<ul>
<li>
<p><a href="https://guides.github.com/features/mastering-markdown/" target="_blank">Mastering Markdown</a></p>
</li>
<li>
<p><a href="https://github.github.com/gfm/">Detailed Specification</a> with many examples</p>
</li>
<li>
<p>Many projects used the Apache CMS for their websites. Here are some differences from its <code>markdown.pl</code>.</p>
</li>
<li>
<p><a href="https://github.github.com/gfm/#html-block">HTML Blocks</a></p>
<ul>
<li>Make sure the first line of your html block starts in column one.</li>
<li>A blank line terminates an html block</li>
<li><a href="https://github.github.com/gfm/#example-139">Exception</a> to this rule for <code>style</code>, <code>pre</code>, and <code>script</code>.</li>
<li><a href="https://github.github.com/gfm/#example-122">Markdown content within an HTML block</a></li>
</ul>
</li>
<li>
<p><a href="https://github.github.com/gfm/#autolink">Autolinks</a></p>
<ul>
<li><a href="https://github.github.com/gfm/#extended-www-autolink">www</a></li>
<li><a href="https://github.github.com/gfm/#extended-url-autolink">url</a></li>
<li><a href="https://github.github.com/gfm/#extended-email-autolink">email</a></li>
</ul>
</li>
<li>
<p><a href="https://github.github.com/gfm/#disallowed-raw-html-extension-">Disallowed html</a> the tagfilter extension disables certain html. The asfgenid plugin reenables <code>script</code>, <code>style</code>, and <code>iframe</code> html.</p>
</li>
<li>
<p><a href="https://sindresorhus.com/github-markdown-css/">Examples</a></p>
</li>
</ul>
<h3>Pelican GFM</h3>
<p>The <code>pelican-gfm</code> plugin <a href="#read-source">reads</a> the content file and renders it to HTML.</p>
<p>From <code>asfreader.py</code>:</p>
<div class="highlight"><pre><span></span><code>            <span class="c1"># Render the markdown into HTML</span>
            <span class="n">content</span> <span class="o">=</span> <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">fp</span><span class="o">.</span><span class="n">getvalue</span><span class="p">()</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">assert</span> <span class="n">content</span>
</code></pre></div>

<p>From <code>pelican-gfm</code>:</p>
<div class="highlight"><pre><span></span><code>    <span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">text</span><span class="p">):</span>
      <span class="s2">&quot;Use cmark-gfm to render the Markdown into an HTML fragment.&quot;</span>

      <span class="n">parser</span> <span class="o">=</span> <span class="n">F_cmark_parser_new</span><span class="p">(</span><span class="n">OPTS</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">parser</span>
      <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">EXTENSIONS</span><span class="p">:</span>
        <span class="n">ext</span> <span class="o">=</span> <span class="n">F_cmark_find_syntax_extension</span><span class="p">(</span><span class="n">name</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">))</span>
        <span class="k">assert</span> <span class="n">ext</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">F_cmark_parser_attach_syntax_extension</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">ext</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">rv</span>
      <span class="n">exts</span> <span class="o">=</span> <span class="n">F_cmark_parser_get_syntax_extensions</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
      <span class="n">F_cmark_parser_feed</span><span class="p">(</span><span class="n">parser</span><span class="p">,</span> <span class="n">text</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">text</span><span class="p">))</span>
      <span class="n">doc</span> <span class="o">=</span> <span class="n">F_cmark_parser_finish</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
      <span class="k">assert</span> <span class="n">doc</span>

      <span class="n">output</span> <span class="o">=</span> <span class="n">F_cmark_render_html</span><span class="p">(</span><span class="n">doc</span><span class="p">,</span> <span class="n">OPTS</span><span class="p">,</span> <span class="n">exts</span><span class="p">)</span>

      <span class="n">F_cmark_parser_free</span><span class="p">(</span><span class="n">parser</span><span class="p">)</span>
      <span class="n">F_cmark_node_free</span><span class="p">(</span><span class="n">doc</span><span class="p">)</span>

      <span class="k">return</span> <span class="n">output</span>
</code></pre></div>

<h2>Generate ID</h2>
<p>We use the <code>asfgenid</code> plugin to perform modifications on the generated content that mimics the markdown extensions in the Apache CMS.
Many of these ASF-specific enhancements are controlled in <a href="../pelicanconf.py">pelican settings</a> in the <code>ASF_GENID</code> dictionary.</p>
<table>
<thead>
<tr>
<th>ASF_GENID key</th>
<th style="text-align: center;">default</th>
<th>process</th>
<th>page override</th>
</tr>
</thead>
<tbody>
<tr>
<td>unsafe_tags</td>
<td style="text-align: center;">True</td>
<td>fix up script, style, and iframe HTML tags that the GFM autofilter extension marks as unsafe</td>
<td></td>
</tr>
<tr>
<td>-</td>
<td style="text-align: center;">-</td>
<td>convert HTML into beautiful soup</td>
<td></td>
</tr>
<tr>
<td>metadata</td>
<td style="text-align: center;">True</td>
<td><code>{{ metadata }}</code> include data in the HTML</td>
<td></td>
</tr>
<tr>
<td>-</td>
<td style="text-align: center;">True</td>
<td>inventory of all ID attributes; duplicates are invalid</td>
<td></td>
</tr>
<tr>
<td>elements</td>
<td style="text-align: center;">True</td>
<td>find all <code>{#id}</code> and <code>{.class}</code> texts and assign attributes</td>
<td></td>
</tr>
<tr>
<td>headings</td>
<td style="text-align: center;">True</td>
<td>assign IDs to all headings w/o IDs already present or assigned with <code>{#id}</code> text</td>
<td>asf_headings</td>
</tr>
<tr>
<td>headings_re</td>
<td style="text-align: center;"><code>r'^h[1-6]'</code></td>
<td>regex for finding headings that require IDs</td>
<td></td>
</tr>
<tr>
<td>tables</td>
<td style="text-align: center;">True</td>
<td>tables with a class attribute are assigned <code>class=table</code></td>
<td></td>
</tr>
<tr>
<td>toc</td>
<td style="text-align: center;">True</td>
<td>generate a table of contents if [TOC] is found. If this is set to False then the <code>toc.py</code> plugin may be used.</td>
<td></td>
</tr>
<tr>
<td>toc_headers</td>
<td style="text-align: center;"><code>r'h[1-6]'</code></td>
<td>headings to include in the [TOC]</td>
<td></td>
</tr>
<tr>
<td>-</td>
<td style="text-align: center;">-</td>
<td>convert beautiful soup back into HTML.</td>
<td></td>
</tr>
</tbody>
</table>
<div class="highlight"><pre><span></span><code><span class="c1"># Configure the asfgenid plugin</span>
<span class="n">ASF_GENID</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s1">&#39;metadata&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;elements&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;headings&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;headings_re&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s1">&#39;^h[1-4]&#39;</span><span class="p">,</span>
    <span class="s1">&#39;permalinks&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;toc&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;toc_headers&#39;</span><span class="p">:</span> <span class="sa">r</span><span class="s2">&quot;h[1-4]&quot;</span><span class="p">,</span>
    <span class="s1">&#39;tables&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span>
    <span class="s1">&#39;debug&#39;</span><span class="p">:</span> <span class="kc">False</span>
<span class="p">}</span>
</code></pre></div>

<h3>Element examples</h3>
<p>Set the heading ID and permalink to <code>#what</code></p>
<div class="highlight"><pre><span></span><code><span class="gu">## What is the Apache Software Foundation?  {#what}</span>

The Apache Software Foundation (ASF) is a non-profit 501(c)(3) corporation,
incorporated in Delaware, USA, in June of 1999. The ASF is a natural
outgrowth of The Apache Group, which
formed in 1995 to develop the Apache HTTP Server.
</code></pre></div>

<p>Set the class to display an image to <code>float-right</code></p>
<div class="highlight"><pre><span></span><code>![<span class="nt">Logo</span>](<span class="na">images/logo.svg</span>) {.float-right}
</code></pre></div>

<p>An HTML fragment is also feasible for a similar purpose</p>
<div class="highlight"><pre><span></span><code><span class="p">&lt;</span><span class="nt">div</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;.pull-right&quot;</span> <span class="na">style</span><span class="o">=</span><span class="s">&quot;float:right; border-style:dotted; width:200px; padding:5px; margin:5px&quot;</span><span class="p">&gt;</span>

SEE INSTEAD: [Trademark Resources Site Map][resources].

<span class="p">&lt;/</span><span class="nt">div</span><span class="p">&gt;</span>
</code></pre></div>

<h3>Heading code</h3>
<p>Code from <code>asfgenid.py</code> uses <a href="https://www.crummy.com/software/BeautifulSoup/bs4/doc/index.html?highlight=javascript#">BeautifulSoup 4</a> to manipulate the rendered HTML. Here is an example:</p>
<div class="highlight"><pre><span></span><code><span class="c1"># from Apache CMS markdown/extensions/headerid.py - slugify in the same way as the Apache CMS</span>
<span class="k">def</span> <span class="nf">slugify</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">separator</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Slugify a string, to make it URL friendly. &quot;&quot;&quot;</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">unicodedata</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="s1">&#39;NFKD&#39;</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">,</span> <span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
    <span class="n">value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[^</span><span class="se">\\</span><span class="s1">w</span><span class="se">\\</span><span class="s1">s-]&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">value</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;ascii&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="s1">&#39;[</span><span class="si">%s</span><span class="se">\\</span><span class="s1">s]+&#39;</span> <span class="o">%</span> <span class="n">separator</span><span class="p">,</span> <span class="n">separator</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

<span class="o">...</span>

<span class="c1"># append a permalink</span>
<span class="k">def</span> <span class="nf">permalink</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">mod_element</span><span class="p">):</span>
    <span class="n">new_tag</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">new_tag</span><span class="p">(</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">href</span><span class="o">=</span><span class="s1">&#39;#&#39;</span> <span class="o">+</span> <span class="n">mod_element</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">])</span>
    <span class="n">new_tag</span><span class="p">[</span><span class="s1">&#39;class&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;headerlink&#39;</span>
    <span class="n">new_tag</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Permalink&#39;</span>
    <span class="n">new_tag</span><span class="o">.</span><span class="n">string</span> <span class="o">=</span> <span class="n">LINK_CHAR</span>
    <span class="n">mod_element</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_tag</span><span class="p">)</span>

<span class="o">...</span>

<span class="c1"># generate ID for a heading</span>
<span class="k">def</span> <span class="nf">headingid_transform</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">soup</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">permalinks</span><span class="p">,</span> <span class="n">perma_set</span><span class="p">):</span>
    <span class="n">new_string</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">new_string</span><span class="p">:</span>
        <span class="c1"># roll up strings if no immediate string</span>
        <span class="n">new_string</span> <span class="o">=</span> <span class="n">tag</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span>
            <span class="n">text</span><span class="o">=</span><span class="k">lambda</span> <span class="n">t</span><span class="p">:</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="n">Comment</span><span class="p">),</span>
            <span class="n">recursive</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">new_string</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">new_string</span><span class="p">)</span>

    <span class="c1"># don&#39;t have an id create it from text</span>
    <span class="n">new_id</span> <span class="o">=</span> <span class="n">slugify</span><span class="p">(</span><span class="n">new_string</span><span class="p">,</span> <span class="s1">&#39;-&#39;</span><span class="p">)</span>
    <span class="n">tag</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique</span><span class="p">(</span><span class="n">new_id</span><span class="p">,</span> <span class="n">ids</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">permalinks</span><span class="p">:</span>
        <span class="n">permalink</span><span class="p">(</span><span class="n">soup</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="c1"># inform if there is a duplicate permalink</span>
        <span class="n">unique</span><span class="p">(</span><span class="n">tag</span><span class="p">[</span><span class="s1">&#39;id&#39;</span><span class="p">],</span> <span class="n">perma_set</span><span class="p">)</span>

<span class="o">...</span>

    <span class="c1"># step 6 - find all headings w/o ids already present or assigned with {#id} text</span>
    <span class="k">if</span> <span class="n">asf_headings</span> <span class="o">==</span> <span class="s1">&#39;True&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">asf_genid</span><span class="p">[</span><span class="s1">&#39;debug&#39;</span><span class="p">]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;headings: </span><span class="si">{</span><span class="n">content</span><span class="o">.</span><span class="n">relative_source_path</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="c1"># Find heading tags</span>
        <span class="n">HEADING_RE</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">asf_genid</span><span class="p">[</span><span class="s1">&#39;headings_re&#39;</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">tag</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">findAll</span><span class="p">(</span><span class="n">HEADING_RE</span><span class="p">,</span> <span class="nb">id</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="n">headingid_transform</span><span class="p">(</span><span class="n">ids</span><span class="p">,</span> <span class="n">soup</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">asf_genid</span><span class="p">[</span><span class="s1">&#39;permalinks&#39;</span><span class="p">],</span> <span class="n">permalinks</span><span class="p">)</span>
</code></pre></div>
        </div>
      </div>
    </div>    
    <!-- footer -->
    <div class="row">
      <div class="large-12 medium-12 columns">
        <p style="font-style: italic; font-size: 0.8rem; text-align: center;">
          Copyright 2024, <a href="https://www.apache.org/">The Apache Software Foundation</a>, Licensed under the <a href="https://www.apache.org/licenses/LICENSE-2.0">Apache License, Version 2.0</a>.<br/>
          Apache&reg; and the Apache feather logo are trademarks of The Apache Software Foundation...
        </p>
      </div>
    </div>
    <script type="application/ecmascript" src="/js/bootstrap.bundle.min.js" integrity="sha384-OERcA2EqjJCMA+/3y+gxIOqMEjwtxJY7qPCqsdltbNJuaOe923+mo//f6V8Qbsw3"></script>      </div>
  </main>
    <script>hljs.initHighlightingOnLoad();</script>
  </body>
</html>
